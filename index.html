<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Wortarten-Training ‚Äì Ringkampf</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #e5e7eb;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .app {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      padding: 2rem 2.5rem;
      max-width: 780px;
      width: 100%;
      box-sizing: border-box;
    }
    h1 {
      margin-top: 0;
      text-align: center;
      font-size: 1.8rem;
    }
    .subtitle {
      text-align: center;
      color: #4b5563;
      margin-bottom: 1.2rem;
      font-size: 0.95rem;
    }
    .center { text-align: center; }

    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #6b7280;
      margin-top: 0.4rem;
      margin-bottom: 0.2rem;
    }

    .choice-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.6rem;
      margin-bottom: 0.6rem;
    }
    .choice-btn {
      padding: 0.8rem 0.6rem;
      border-radius: 14px;
      border: 2px solid #d1d5db;
      background: #f9fafb;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.05s ease,
                  border-color 0.15s ease, box-shadow 0.15s ease;
    }
    .choice-btn.selected {
      background: #2563eb;
      color: #ffffff;
      border-color: #1d4ed8;
      box-shadow: 0 5px 15px rgba(37,99,235,0.35);
    }
    .choice-btn:active { transform: translateY(1px); }

    .selected-info {
      font-size: 0.85rem;
      color: #6b7280;
      text-align: center;
      min-height: 1.2rem;
      margin-bottom: 0.5rem;
    }

    .primary-btn {
      margin-top: 0.9rem;
      width: 100%;
      padding: 0.7rem 1rem;
      font-size: 1.05rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: white;
      font-weight: 600;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.2s ease;
    }
    .primary-btn:hover { background: #1d4ed8; }
    .primary-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .primary-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      box-shadow: none;
    }

    .secondary-btn {
      margin-top: 0.4rem;
      width: 100%;
      padding: 0.6rem 1rem;
      font-size: 1rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      cursor: pointer;
      background: #f9fafb;
      color: #111827;
      font-weight: 500;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.2s ease, border-color 0.2s ease;
    }
    .secondary-btn:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }
    .secondary-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .hidden { display: none; }

    /* Quizbereich */
    .info-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: #4b5563;
      margin-top: 0.3rem;
    }
    .timer {
      font-weight: 700;
    }
    .timer.low { color: #b91c1c; }

    .word-display {
      font-size: 2.4rem;
      font-weight: 700;
      margin: 1rem 0 0.8rem;
      text-align: center;
      letter-spacing: 0.04em;
    }

    .tagline {
      font-size: 0.9rem;
      text-align: center;
      color: #6b7280;
      margin-top: 0.2rem;
    }

    .pos-grid {
      margin-top: 0.6rem;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.5rem;
    }
    .pos-btn {
      padding: 0.6rem 0.5rem;
      border-radius: 14px;
      border: 2px solid #d1d5db;
      background: #f9fafb;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.05s ease,
                  border-color 0.15s ease, box-shadow 0.15s ease;
      text-align: center;
      word-break: break-word;
      color: #111827;
    }
    .pos-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    /* Wortarten-Farben */
    .pos-btn.nomen {
      background: #b5651d; /* Braun */
      border-color: #8a4b14;
      color: #fff;
    }
    .pos-btn.nomen:hover { background: #a05719; }

    .pos-btn.verb {
      background: #2563eb; /* Blau */
      border-color: #1d4ed8;
      color: #fff;
    }
    .pos-btn.verb:hover { background: #1d4ed8; }

    .pos-btn.adjektiv {
      background: #facc15; /* Gelb */
      border-color: #eab308;
      color: #111;
    }
    .pos-btn.adjektiv:hover { background: #eab308; }

    .pos-btn.pronomen {
      background: #f97316; /* Orange */
      border-color: #ea580c;
      color: #fff;
    }
    .pos-btn.pronomen:hover { background: #ea580c; }

    .pos-btn.partikel {
      background: #22c55e; /* Gr√ºn */
      border-color: #16a34a;
      color: #fff;
    }
    .pos-btn.partikel:hover { background: #16a34a; }

    .feedback {
      min-height: 1.4rem;
      margin-top: 0.6rem;
      font-weight: 500;
      text-align: center;
    }
    .feedback.ok { color: #15803d; }
    .feedback.error { color: #b91c1c; }

    .stats {
      margin-top: 0.6rem;
      font-size: 0.9rem;
      color: #374151;
    }

    /* Arena / Ringkampf */
    .arena-wrapper {
      margin-top: 1rem;
      padding: 0.8rem;
      border-radius: 14px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
    }
    .arena-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      margin-bottom: 0.35rem;
    }
    .score {
      font-weight: 600;
    }
    .arena {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 0.6rem;
    }
    .fighter {
      font-size: 2.1rem;
    }
    .track {
      display: grid;
      grid-template-columns: repeat(9, minmax(0, 1fr));
      gap: 0.12rem;
      align-items: center;
    }
    .track-cell {
      height: 14px;
      border-radius: 999px;
      background: #e5e7eb;
      position: relative;
    }
    .track-cell.mid {
      background: #d1d5db;
    }
    .marker {
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #fbbf24;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.08);
    }

    #result-screen h2 {
      margin-bottom: 0.3rem;
    }
    #result-summary {
      font-size: 0.95rem;
      color: #374151;
    }
  </style>
</head>
<body>
<div class="app">
  <h1>Wortarten ‚Äì Trainingskampf</h1>
  <div class="subtitle">
    Bestimme die Wortart: Nomen, Verb, Adjektiv, Pronomen oder Partikel.<br>
    Entweder im Trainingsmodus oder als Wettkampf gegen den Roboter.
  </div>

  <!-- STARTSCREEN -->
  <div id="start-screen">
    <div class="section-title">Modus w√§hlen</div>
    <div class="choice-grid" id="mode-grid">
      <button type="button" class="choice-btn mode-btn" data-mode="training">
        Training (ohne Timer, ohne Wettkampf)
      </button>
      <button type="button" class="choice-btn mode-btn" data-mode="t3">
        Wettkampf ‚Äì 3&nbsp;s pro Wort
      </button>
      <button type="button" class="choice-btn mode-btn" data-mode="t5">
        Wettkampf ‚Äì 5&nbsp;s pro Wort
      </button>
      <button type="button" class="choice-btn mode-btn" data-mode="t10">
        Wettkampf ‚Äì 10&nbsp;s pro Wort
      </button>
    </div>

    <div class="selected-info" id="selected-info"></div>
    <button class="primary-btn" id="start-btn" disabled>Los geht's!</button>
  </div>

  <!-- QUIZSCREEN -->
  <div id="quiz-screen" class="hidden">
    <div class="info-row">
      <div id="mode-label"></div>
      <div class="timer" id="timer-display"></div>
    </div>

    <div class="word-display" id="word-display">kind</div>
    <div class="tagline">Klicke die passende Wortart an.</div>

    <div class="pos-grid">
      <button type="button" class="pos-btn nomen"    data-pos="nomen">Nomen</button>
      <button type="button" class="pos-btn verb"     data-pos="verb">Verb</button>
      <button type="button" class="pos-btn adjektiv" data-pos="adjektiv">Adjektiv</button>
      <button type="button" class="pos-btn pronomen" data-pos="pronomen">Pronomen</button>
      <button type="button" class="pos-btn partikel" data-pos="partikel">Partikel</button>
    </div>

    <div class="feedback" id="feedback"></div>

    <div class="stats">
      W√∂rter gel√∂st: <span id="stat-questions">0</span><br>
      Richtig: <span id="stat-correct">0</span>, Falsch: <span id="stat-wrong">0</span><br>
      Wettkampf-Punkte (nur im Wettkampf):<br>
      Du: <span id="stat-player">0</span> ‚Äì Roboter: <span id="stat-pc">0</span>
    </div>

    <div class="arena-wrapper" id="arena-wrapper">
      <div class="arena-header">
        <div class="score" id="score-text">0 : 0</div>
        <div style="font-size:0.85rem;color:#6b7280;">
          Richtig: ein Schritt nach rechts<br>
          Falsch / Zeit abgelaufen: ein Schritt nach links<br>
          4 Schritte = 1 Punkt
        </div>
      </div>
      <div class="arena">
        <div class="fighter">ü§ñ</div>
        <div class="track" id="track"></div>
        <div class="fighter">üßë‚Äçüéì</div>
      </div>
    </div>
  </div>

  <!-- RESULTSCREEN -->
  <div id="result-screen" class="hidden center">
    <h2 id="result-title">Fertig!</h2>
    <p id="result-summary"></p>
    <p style="margin-top:0.8rem; font-size:0.9rem; color:#4b5563;">
      Wenn du mit deinem Wettkampf zufrieden bist, klicke auf <strong>‚ÄûFertig‚Äú</strong>,<br>
      damit LearningView den Auftrag als erledigt markiert.<br>
      Mit <strong>‚ÄûNochmals spielen‚Äú</strong> kannst du einen neuen Kampf starten.
    </p>
    <button class="primary-btn" id="finish-btn">Fertig</button>
    <button class="secondary-btn" id="again-btn">Nochmals spielen</button>
  </div>
</div>

<!-- Audio-WAV-Dateien im Ordner audio/ -->
<audio id="sound-correct"   src="audio/correct.wav"   preload="auto"></audio>
<audio id="sound-error"     src="audio/error.wav"     preload="auto"></audio>
<audio id="sound-roundwon"  src="audio/roundwon.wav"  preload="auto"></audio>
<audio id="sound-roundlost" src="audio/roundlost.wav" preload="auto"></audio>
<audio id="sound-gamewon"   src="audio/gamewon.wav"   preload="auto"></audio>
<audio id="sound-youwon"    src="audio/youwon.wav"    preload="auto"></audio>
<audio id="sound-gamelost"  src="audio/gamelost.wav"  preload="auto"></audio>

<script>
  // --- Konfiguration ---
  const STEP_WIN = 4;      // 4 Schritte nach links/rechts = Punkt
  const POINTS_TO_WIN = 3; // 3 Punkte = Spielende

  const TIME_LIMITS = {
    t3: 3,
    t5: 5,
    t10: 10
  };

  // Zentraler Wortschatz
  const WORDS = {
    nomen: [
      "haus","baum","mutter","vater","kind","schule","buch","stift","tisch","fenster",
      "t√ºr","bett","auto","fahrrad","ball","blume","sonne","mond","stern","wolke",
      "regen","schnee","hund","katze","maus","fisch","vogel","pferd","kuh","schaf",
      "brot","milch","wasser","apfel","banane","orange","keks","kuchen","teller","glas",
      "messer","gabel","l√∂ffel","jacke","hose","hut","schuh","socke","hand","fuss",
      "kopf","auge","ohr","nase","mund","haar","zahn","garten","park","strasse",
      "br√ºcke","fluss","see","berg","tal","wald","wiese","uhr","tag","nacht",
      "morgen","abend","jahr","monat","woche","freund","lehrer","arzt","polizist","feuer",
      "licht","farbe","bild","lied","spiel","zahl","buchstabe","name","adresse","telefon",
      "brief","paket","geschenk","feiertag","geburtstag","weihnachten","sommer","winter","fr√ºhling","herbst"
    ],
    verb: [
      "gehen","spielen","lesen","schreiben","malen","lachen","springen","sehen","h√∂ren","sagen",
      "fragen","antworten","kommen","laufen","rennen","stehen","sitzen","liegen","schlafen","tr√§umen",
      "essen","trinken","kochen","backen","waschen","putzen","r√§umen","bauen","basteln","zeichnen",
      "rechnen","z√§hlen","singen","tanzen","musizieren","pfeifen","klatschen","winken","zeigen","geben",
      "nehmen","halten","tragen","bringen","holen","kaufen","verkaufen","bezahlen","√∂ffnen","schliessen",
      "dr√ºcken","ziehen","schieben","heben","senken","drehen","biegen","brechen","reparieren","arbeiten",
      "lernen","lehren","helfen","st√∂ren","warten","suchen","finden","verlieren","gewinnen","verstecken",
      "entdecken","denken","glauben","wissen","kennen","verstehen","erkl√§ren","erz√§hlen","versprechen","vergessen",
      "erinnern","hoffen","f√ºrchten","lieben","m√∂gen","hassen","d√ºrfen","k√∂nnen","m√ºssen","sollen",
      "wollen","werden","sein","haben"
    ],
    adjektiv: [
      "gross","klein","schnell","langsam","hell","dunkel","fr√∂hlich","traurig","bunt","rund",
      "eckig","schwer","leicht","hart","weich","warm","kalt","heiss","k√ºhl","neu",
      "alt","jung","altmodisch","modern","sauber","schmutzig","ordentlich","unordentlich","laut","leise",
      "stark","schwach","hoch","niedrig","lang","kurz","breit","schmal","dick","d√ºnn",
      "voll","leer","super","grossartig","teuer","billig","gut","schlecht","richtig","falsch",
      "einfach","schwierig","sicher","gef√§hrlich","gesund","krank","m√ºde","wach","hungrig","satt",
      "durstig","nass","trocken","glatt","rau","s√ºss","sauer","salzig","bitter","scharf",
      "frisch","faul","lebendig","tot","lauter","still","aufgeregt","ruhig","neugierig","gleichg√ºltig",
      "geduldig","ungeduldig","freundlich","unfreundlich","h√∂flich","unh√∂flich","fleissig","klug","dumm","mutig",
      "√§ngstlich","zufrieden","unzufrieden","gl√ºcklich","ungl√ºcklich","gelassen"
    ],
    pronomen: [
      "ich","du","er","sie","es","wir","ihr","meine","deine","seine",
      "unser","euer","mich","dich","sich","ihn","uns","euch","jemand","niemand",
      "etwas","nichts","alles","jeder","jede","jedes","mancher","manche","manches","welcher",
      "welche","welches","dieser","diese","dieses","jener","jene","jenes","derselbe","dieselbe",
      "dasselbe","solcher","solche","solches","irgendwer","irgendetwas","einiger","einige","einiges","anderer",
      "andere","anderes"
    ],
    partikel: [
      "nicht","auch","noch","schon","immer","oft","vielleicht","gerade","besonders","doch",
      "denn","ja","nein","ziemlich","recht","ganz","etwas","etwa","fast","beinahe",
      "eben","genau","wirklich","eigentlich","sogar","selbst","einfach","bloss","nur","erst",
      "immerhin","jedenfalls","sowieso","trotzdem","deshalb","daher","darum","also","folglich","dennoch",
      "allerdings","jedoch","aber","oder","und","sondern","beziehungsweise","entweder","weder","ob",
      "dass","damit","obwohl","wenn","als","wie","weil","da","falls","sobald",
      "bis","seit","w√§hrend","bevor","nachdem","indem","ohne","mit","bei","von",
      "zu","aus","durch","f√ºr","gegen","um","an","auf","hinter","neben",
      "in","√ºber","unter","vor","zwischen","links","rechts","oben","unten","vorne",
      "hinten","innen","aussen","heute","gestern","morgen","jetzt","gleich","sp√§ter","fr√ºher"
    ]
  };

  const POS_LABELS = {
    nomen: "Nomen",
    verb: "Verb",
    adjektiv: "Adjektiv",
    pronomen: "Pronomen",
    partikel: "Partikel"
  };

  // --- Zustand ---
  let selectedMode = null;    // 'training', 't3', 't5', 't10'
  let isTrainingMode = false;

  let timeLimit = 0;
  let timeLeft = 0;
  let timerId = null;

  let currentWord = "";
  let currentClassKey = "";

  let position = 0;      // -4..+4, 0 = Mitte
  let playerPoints = 0;
  let pcPoints = 0;
  let questionsCount = 0;
  let correctCount = 0;
  let wrongCount = 0;

  let gameOver = false;
  let isAnswerLocked = false; // NEU: nur ein Klick pro Wort

  // --- DOM ---
  const startScreen = document.getElementById("start-screen");
  const quizScreen = document.getElementById("quiz-screen");
  const resultScreen = document.getElementById("result-screen");

  const modeGrid = document.getElementById("mode-grid");
  const selectedInfo = document.getElementById("selected-info");
  const startBtn = document.getElementById("start-btn");

  const modeLabel = document.getElementById("mode-label");
  const timerDisplay = document.getElementById("timer-display");
  const wordDisplay = document.getElementById("word-display");
  const feedbackEl = document.getElementById("feedback");

  const statQuestions = document.getElementById("stat-questions");
  const statCorrect = document.getElementById("stat-correct");
  const statWrong = document.getElementById("stat-wrong");
  const statPlayer = document.getElementById("stat-player");
  const statPc = document.getElementById("stat-pc");
  const scoreText = document.getElementById("score-text");
  const trackEl = document.getElementById("track");
  const arenaWrapper = document.getElementById("arena-wrapper");

  const resultTitle = document.getElementById("result-title");
  const resultSummary = document.getElementById("result-summary");
  const finishBtn = document.getElementById("finish-btn");
  const againBtn = document.getElementById("again-btn");

  const posButtons = document.querySelectorAll(".pos-btn");

  // --- Audio-Helfer ---
  function playSound(id) {
    const el = document.getElementById(id);
    if (!el) return;
    try {
      el.currentTime = 0;
      el.play().catch(() => {});
    } catch (e) {
      console.warn("Audio-Fehler:", e);
    }
  }

  // --- Anzeige-Helfer: technische Schreibweise -> Anzeige f√ºr Kinder ---
  function displayWord(raw) {
    if (!raw) return "";
    let w = raw;
    w = w.replace(/ae/g, "√§")
         .replace(/oe/g, "√∂");
    w = w.replace(/√ü/g, "ss");
    return w;
  }

  // --- Modus-Auswahl ---
  modeGrid.querySelectorAll(".mode-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const m = btn.dataset.mode;
      selectedMode = (selectedMode === m) ? null : m;
      modeGrid.querySelectorAll(".mode-btn").forEach(b => {
        b.classList.toggle("selected", b.dataset.mode === selectedMode);
      });
      updateStartState();
    });
  });

  function updateStartState() {
    if (!selectedMode) {
      selectedInfo.textContent = "Bitte einen Modus ausw√§hlen.";
      startBtn.disabled = true;
      return;
    }
    let modeText = "";
    if (selectedMode === "training") {
      modeText = "Training ohne Timer und ohne Wettkampf";
    } else if (selectedMode === "t3") {
      modeText = "Wettkampf mit 3 Sekunden pro Wort";
    } else if (selectedMode === "t5") {
      modeText = "Wettkampf mit 5 Sekunden pro Wort";
    } else if (selectedMode === "t10") {
      modeText = "Wettkampf mit 10 Sekunden pro Wort";
    }
    selectedInfo.textContent = modeText;
    startBtn.disabled = false;
  }

  startBtn.addEventListener("click", startGame);

  function startGame() {
    isTrainingMode = (selectedMode === "training");
    gameOver = false;

    questionsCount = 0;
    correctCount = 0;
    wrongCount = 0;
    position = 0;
    playerPoints = 0;
    pcPoints = 0;
    isAnswerLocked = false;

    if (isTrainingMode) {
      arenaWrapper.classList.add("hidden");
      timerDisplay.textContent = "Kein Timer (Training)";
    } else {
      arenaWrapper.classList.remove("hidden");
      timeLimit = TIME_LIMITS[selectedMode] || 10;
    }

    updateStats();
    buildTrack();
    updateTrack();

    feedbackEl.textContent = "";
    feedbackEl.className = "feedback";

    let modeText = "";
    if (isTrainingMode) modeText = "Training: Wortarten ohne Timer";
    else if (selectedMode === "t3") modeText = "Wettkampf: 3 Sekunden pro Wort";
    else if (selectedMode === "t5") modeText = "Wettkampf: 5 Sekunden pro Wort";
    else if (selectedMode === "t10") modeText = "Wettkampf: 10 Sekunden pro Wort";
    modeLabel.textContent = modeText;

    startScreen.classList.add("hidden");
    resultScreen.classList.add("hidden");
    quizScreen.classList.remove("hidden");

    nextQuestion();
  }

  // --- Wort-Generator ---
  function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function pickRandomClassKey() {
    const keys = Object.keys(WORDS);
    return keys[randInt(0, keys.length - 1)];
  }

  function pickRandomWordFromClass(classKey) {
    const arr = WORDS[classKey];
    const idx = randInt(0, arr.length - 1);
    return arr[idx];
  }

  function nextQuestion() {
    if (gameOver) return;

    feedbackEl.textContent = "";
    feedbackEl.className = "feedback";

    const clsKey = pickRandomClassKey();
    const word = pickRandomWordFromClass(clsKey);

    currentClassKey = clsKey;
    currentWord = word;

    wordDisplay.textContent = displayWord(currentWord);

    // NEU: Buttons wieder freigeben
    isAnswerLocked = false;
    posButtons.forEach(btn => btn.disabled = false);

    if (!isTrainingMode) {
      resetTimer();
    } else {
      timerDisplay.textContent = "Kein Timer (Training)";
    }
  }

  // --- Timer f√ºr Wettkampf ---
  function resetTimer() {
    if (timerId) clearInterval(timerId);
    timeLeft = timeLimit;
    updateTimerUI();

    timerId = setInterval(() => {
      timeLeft--;
      updateTimerUI();
      if (timeLeft <= 0) {
        clearInterval(timerId);
        timerId = null;
        handleAnswer(null, true);
      }
    }, 1000);
  }

  function updateTimerUI() {
    if (isTrainingMode) {
      timerDisplay.textContent = "Kein Timer (Training)";
      timerDisplay.classList.remove("low");
      return;
    }
    timerDisplay.textContent = `Restzeit: ${timeLeft}s`;
    timerDisplay.classList.toggle("low", timeLeft <= 2);
  }

  // --- Arena / Marker ---
  function buildTrack() {
    trackEl.innerHTML = "";
    for (let i = 0; i < 9; i++) {
      const cell = document.createElement("div");
      cell.className = "track-cell";
      if (i === 4) cell.classList.add("mid");
      trackEl.appendChild(cell);
    }
  }

  function updateTrack() {
    const cells = trackEl.querySelectorAll(".track-cell");
    cells.forEach(c => {
      const marker = c.querySelector(".marker");
      if (marker) c.removeChild(marker);
    });
    const idx = position + 4;
    if (idx >= 0 && idx < cells.length) {
      const marker = document.createElement("div");
      marker.className = "marker";
      cells[idx].appendChild(marker);
    }
    scoreText.textContent = `${playerPoints} : ${pcPoints}`;
  }

  function updateStats() {
    statQuestions.textContent = questionsCount.toString();
    statCorrect.textContent = correctCount.toString();
    statWrong.textContent = wrongCount.toString();
    statPlayer.textContent = playerPoints.toString();
    statPc.textContent = pcPoints.toString();
  }

  // --- Antwort-Handling ---
  posButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const pos = btn.getAttribute("data-pos");
      handleAnswer(pos, false);
    });
  });

  function handleAnswer(chosenPos, isTimeout) {
    if (gameOver) return;
    if (isAnswerLocked) return;      // NEU: Mehrfachklicks ignorieren
    isAnswerLocked = true;
    posButtons.forEach(btn => btn.disabled = true);

    if (!isTrainingMode && timerId) {
      clearInterval(timerId);
      timerId = null;
    }

    questionsCount++;

    const isCorrect = (!isTimeout && chosenPos === currentClassKey);

    if (isCorrect) {
      correctCount++;
      feedbackEl.textContent = "Richtig! üëç";
      feedbackEl.className = "feedback ok";
      playSound("sound-correct");
    } else {
      wrongCount++;
      feedbackEl.textContent = isTimeout
        ? "Zeit abgelaufen ‚Äì das war leider falsch."
        : "Leider falsch.";
      feedbackEl.className = "feedback error";
      playSound("sound-error");
    }

    if (isTrainingMode) {
      updateStats();
      setTimeout(() => {
        nextQuestion();
      }, 800);
      return;
    }

    // Wettkampf-Logik
    if (isCorrect) {
      position = Math.min(position + 1, STEP_WIN);
    } else {
      position = Math.max(position - 1, -STEP_WIN);
    }

    if (position >= STEP_WIN) {
      playerPoints++;
      position = 0;
      feedbackEl.textContent += " Du gewinnst eine Runde!";
      feedbackEl.className = "feedback ok";
      playSound("sound-roundwon");
    } else if (position <= -STEP_WIN) {
      pcPoints++;
      position = 0;
      feedbackEl.textContent += " Der Roboter gewinnt eine Runde.";
      feedbackEl.className = "feedback error";
      playSound("sound-roundlost");
    }

    updateTrack();
    updateStats();

    if (playerPoints >= POINTS_TO_WIN || pcPoints >= POINTS_TO_WIN) {
      setTimeout(endGame, 700);
    } else {
      setTimeout(() => {
        nextQuestion();
      }, 800);
    }
  }

  function endGame() {
    gameOver = true;
    if (timerId) clearInterval(timerId);

    quizScreen.classList.add("hidden");
    resultScreen.classList.remove("hidden");

    const win = playerPoints > pcPoints;
    if (win) {
      resultTitle.textContent = "Sieg im Wortarten-Kampf! üéâ";
      playSound("sound-gamewon");
      setTimeout(() => {
        playSound("sound-youwon");
      }, 700);
    } else {
      resultTitle.textContent = "Der Roboter gewinnt üòï";
      playSound("sound-gamelost");
    }

    resultSummary.innerHTML =
      `Du hast insgesamt <strong>${questionsCount}</strong> W√∂rter gel√∂st.<br>` +
      `Davon waren <strong>${correctCount}</strong> richtig und <strong>${wrongCount}</strong> falsch.<br>` +
      `Wettkampf-Punkte: <strong>Du ${playerPoints}</strong> ‚Äì <strong>Roboter ${pcPoints}</strong>.`;

    finishBtn.disabled = false;
    finishBtn.textContent = "Fertig";
  }

  // LearningView-Feedback nur nach Wettkampf
  finishBtn.addEventListener("click", () => {
    finishBtn.disabled = true;
    finishBtn.textContent = "Erledigt ‚úî";
    try {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage("AppSolved", "*");
      }
    } catch (e) {
      console.warn("LearningView-AppSolved nicht m√∂glich:", e);
    }
  });

  againBtn.addEventListener("click", () => {
    resultScreen.classList.add("hidden");
    startScreen.classList.remove("hidden");
  });

  // --- Init ---
  (function init() {
    buildTrack();
    updateTrack();
    updateStartState();
  })();
</script>
</body>
</html>
